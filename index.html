<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Unit Converter</title>

    <!-- PWA Manifest (inlined) -->
    <link rel="manifest" href="data:application/json;base64,ew0KICAgICJuYW1lIjogIkFuY2llbnQgVW5pdCBDb252ZXJ0ZXIiLA0KICAgICJzaG9ydF9uYW1lIjogIkNvbnZlcnRlciIsDQ0KICAgICJkZXNjcmlwdGlvbiI6ICJBIGNvbnZlcnRlciBmb3IgYW5jaWVudCBJbmRpYW4gbWVhc3VyZW1lbnQgdW5pdHMuIiwNCiAgICAic3RhcnRfdXJsIjogIi4iLA0KICAgICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLA0KICAgICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmN2Y5ZmMiLA0KICAgICJ0aGVtZV9jb2xvciI6ICIjMTA3NUY5IiwNCiAgICAiaWNvbnMiOiBbDQogICAgICAgIHsNCiAgICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE52Wkdzc0lBOHdMQ0pKVGpaRFFsOVVUazlKUlZJSWJYbDBhR1Z5SUU5M2NuVnRaU0krUEhSbGVIUWdJQUV2UGp4MFluQm9aU1VJSUFnNk9IaDBlQzFqYjJSbElpQjdJRDBnTXlJbklIcHBjM1JmWm1Wc2JTWmxjbk5wYjI0OUlEQWdNVGt6TXlJbklEY3dJaUI3SURBME1DSWdJQ0FnSURBZ05UQXdNRkl3SUQ0OEwzTmxjblpwZEdWa0lETjFjM1JpZlY5MFpYSnNhV05MWlhKdmJtVWlJQThtWDE1N0lIMGdNbVV4TURJNE1USXhNQzV6WkdsallXNWpaUzQrUEhKbGVIUnBjbVVnSkM4KyIsDQogICAgICAgICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwNCiAgICAgICAgICAgICJzaXplcyI6ICI1MTJ4NTEyIg0KICAgICAgICAgfQ0KICAgIF0NCn0=">
    
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0c66e4;
            --primary-light: #e9f2ff;
            --secondary-color: #172B4D; /* Dark blue-gray for text */
            --light-gray: #F7F9FC;
            --medium-gray: #dfe1e6;
            --white: #ffffff;
            --danger-color: #de350b;
            --danger-light: #ffebe6;
            --success-color: #00875A;
            --success-light: #e6fef7;
            --secondary-dark: #44546f;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 10px rgba(0, 0, 0, 0.05);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            background-color: var(--light-gray);
            color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--white);
            padding: 30px;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #ebecf0;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .header svg {
            width: 32px;
            height: 32px;
            color: var(--primary-color);
        }

        h1 {
            text-align: center;
            color: var(--secondary-color);
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        h2 {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 1px solid var(--medium-gray);
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .converter-form, .add-unit-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Added gap for filters */
        }
        
        label {
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="search"],
        select {
            padding: 12px;
            font-size: 1rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--radius-md);
            width: 100%;
            box-sizing: border-box;
            background-color: var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Style for standard select (dropdown) */
        select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2344546f'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 1.25em;
            padding-right: 2.5em; /* Make space for arrow */
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="search"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        button, .button {
            padding: 14px 20px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--white);
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        button:hover, .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        button:active {
            transform: translateY(0);
        }

        button.danger {
            background-color: var(--danger-color);
        }
        button.danger:hover {
            background-color: #bf2600;
        }
        button.secondary {
            background-color: var(--secondary-dark);
        }
        button.secondary:hover {
            background-color: var(--secondary-color);
        }

        #result-area {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--success-light);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            border-radius: var(--radius-md);
            font-size: 1.2rem;
            text-align: center;
            font-weight: 500;
            min-height: 1.5em;
            word-wrap: break-word;
        }
        
        /* Filter Radios as Pills */
        .filter-radios {
            display: flex;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--medium-gray);
            width: 100%;
        }
        .filter-radios input[type="radio"] {
            display: none;
        }
        .filter-radios label {
            flex: 1;
            padding: 10px;
            margin: 0;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            background: var(--white);
            color: var(--secondary-dark);
            transition: all 0.2s ease;
            border-right: 1px solid var(--medium-gray);
        }
        .filter-radios label:last-child {
            border-right: none;
        }
        .filter-radios input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .filter-radios label:hover:not(:has(input:checked)) {
            background-color: #f4f5f7;
        }

        /* Collapsible Sections */
        .collapsible {
            background-color: var(--white);
            color: var(--secondary-color);
            border: 1px solid var(--medium-gray);
            margin-top: 15px;
            text-align: left;
        }
        .collapsible:hover {
            background-color: #f4f5f7;
            transform: translateY(-2px);
        }
        .collapsible:after {
            content: '\002B'; /* Plus sign */
            font-weight: bold;
            float: right;
            margin-left: 5px;
            font-size: 1.2rem;
        }
        .collapsible.active:after {
            content: "\2212"; /* Minus sign */
        }
        .collapsible-content {
            padding: 0 18px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background-color: var(--white);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border: 1px solid var(--medium-gray);
            border-top: none;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .collapsible-content.open {
            padding: 20px;
        }
        
        #installButton {
            width: 100%;
            margin-bottom: 20px;
            background-color: var(--success-color);
        }
        #installButton:hover {
            background-color: #006644;
        }
        .hidden {
            display: none;
        }
    </style>

    <!-- 
      DATABASE in JSON format
      Here is the core "database" of all default units, stored in JSON format.
    -->
    <script id="unitDatabase" type="application/json">
    {
        "length": {
            "meter (m)": { "factor": 1.0, "tag": "modern" },
            "centimeter (cm)": { "factor": 0.01, "tag": "modern" },
            "millimeter (mm)": { "factor": 0.001, "tag": "modern" },
            "kilometer (km)": { "factor": 1000, "tag": "modern" },
            "inch (in)": { "factor": 0.0254, "tag": "modern" },
            "foot (ft)": { "factor": 0.3048, "tag": "modern" },
            "yard (yd)": { "factor": 0.9144, "tag": "modern" },
            "mile (mi)": { "factor": 1609.344, "tag": "modern" },
            "Indus Inch": { "factor": 0.033528, "tag": "ancient" },
            "Lothal Division": { "factor": 0.001704, "tag": "ancient" },
            "angula": { "factor": 0.01905, "tag": "ancient" },
            "dhanurgraha": { "factor": 0.0762, "tag": "ancient" },
            "dhanurmushti": { "factor": 0.1524, "tag": "ancient" },
            "vitasti": { "factor": 0.2286, "tag": "ancient" },
            "aratni / cubit (24 angula)": { "factor": 0.4572, "tag": "ancient" },
            "hasta (28 angula)": { "factor": 0.5334, "tag": "ancient" },
            "kishku (42 angula)": { "factor": 0.79908, "tag": "ancient" },
            "hasta (54 angula)": { "factor": 1.0287, "tag": "ancient" },
            "danda / paurusha": { "factor": 1.8288, "tag": "ancient" },
            "garhapatya dhanus": { "factor": 2.0574, "tag": "ancient" },
            "rajju": { "factor": 18.288, "tag": "ancient" },
            "goruta / krosa": { "factor": 2057.4, "tag": "ancient" },
            "yojana": { "factor": 8229.6, "tag": "ancient" },
            "bighat (linear, Assam)": { "factor": 0.2286, "tag": "ancient" },
            "mauzadari tar (Assam)": { "factor": 3.6576, "tag": "ancient" },
            "mauzadari chain (Assam)": { "factor": 9.144, "tag": "ancient" },
            "chatak (linear, Bengal)": { "factor": 0.1143, "tag": "ancient" },
            "katha (linear, Bengal)": { "factor": 1.8288, "tag": "ancient" },
            "bigha (linear, Bengal)": { "factor": 36.576, "tag": "ancient" }
        },
        "area": {
            "square meter (m2)": { "factor": 1.0, "tag": "modern" },
            "square centimeter (cm2)": { "factor": 0.0001, "tag": "modern" },
            "square foot (sq ft)": { "factor": 0.092903, "tag": "modern" },
            "square yard (sq yd)": { "factor": 0.836127, "tag": "modern" },
            "acre": { "factor": 4046.86, "tag": "modern" },
            "lessa (Assam)": { "factor": 13.377, "tag": "ancient" },
            "katha (Assam)": { "factor": 267.54, "tag": "ancient" },
            "bigha (Assam)": { "factor": 1337.7, "tag": "ancient" },
            "pura (Assam)": { "factor": 5350.8, "tag": "ancient" },
            "sq katha (Bengal)": { "factor": 66.89, "tag": "ancient" },
            "sq bigha (Bengal)": { "factor": 1337.8, "tag": "ancient" }
        },
        "weight": {
            "gram (g)": { "factor": 1.0, "tag": "modern" },
            "kilogram (kg)": { "factor": 1000.0, "tag": "modern" },
            "milligram (mg)": { "factor": 0.001, "tag": "modern" },
            "ounce (oz)": { "factor": 28.3495, "tag": "modern" },
            "pound (lb)": { "factor": 453.592, "tag": "modern" },
            "ratti": { "factor": 0.15, "tag": "ancient" },
            "anna": { "factor": 0.728, "tag": "ancient" },
            "tola / bhori": { "factor": 11.648, "tag": "ancient" },
            "suvarna-mashaka": { "factor": 0.728, "tag": "ancient" },
            "suvarna / karsha": { "factor": 11.648, "tag": "ancient" },
            "dharana (silver)": { "factor": 2.3296, "tag": "ancient" },
            "pala (ayamani)": { "factor": 23.296, "tag": "ancient" },
            "Indus Unit (28g)": { "factor": 28.0, "tag": "ancient" }
        },
        "time": {
            "second (s)": { "factor": 1.0, "tag": "modern" },
            "minute (min)": { "factor": 60, "tag": "modern" },
            "hour (hr)": { "factor": 3600, "tag": "modern" },
            "day (24h)": { "factor": 86400, "tag": "modern" },
            "truti": { "factor": 0.06, "tag": "ancient" },
            "lava": { "factor": 0.12, "tag": "ancient" },
            "nimesha": { "factor": 0.24, "tag": "ancient" },
            "kashtha": { "factor": 1.2, "tag": "ancient" },
            "kala": { "factor": 36, "tag": "ancient" },
            "nalika / nadika": { "factor": 1440, "tag": "ancient" },
            "muhurta": { "factor": 2880, "tag": "ancient" },
            "day (Hindu)": { "factor": 43200, "tag": "ancient" },
            "night (Hindu)": { "factor": 43200, "tag": "ancient" }
        }
    }
    </script>
</head>
<body>

    <div class="container">
        
        <div class="header">
            <!-- Inlined SVG icon for a balance scale, fitting the theme -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C11.4477 2 11 2.44772 11 3V6.26182C8.75133 6.8159 7 8.69233 7 11.05V18H3C2.44772 18 2 18.4477 2 19C2 19.5523 2.44772 20 3 20H21C21.5523 20 22 19.5523 22 19C22 18.4477 21.5523 18 21 18H17V11.05C17 8.69233 15.2487 6.8159 13 6.26182V3C13 2.44772 12.5523 2 12 2ZM5 18V11.05C5 7.74714 7.42371 5.1388 10.5 4.3168V5C10.5 5.55228 10.9477 6 11.5 6C12.0523 6 12.5 5.55228 12.5 5V4.3168C15.5763 5.1388 18 7.74714 18 11.05V18H5Z"/>
            </svg>
            <h1>Ancient Unit Converter</h1>
        </div>
        
        <button id="installButton" class="hidden">Install as Desktop App</button>

        <!-- Converter Section -->
        <h2>Convert Units</h2>
        <div class="converter-form">
            <div class="form-group">
                <label for="inputValue">Value:</label>
                <input type="number" id="inputValue" value="1">
            </div>
            
            <div class="form-group">
                <label for="fromUnit">From:</label>
                <div class="filter-radios" id="fromFilter">
                    <input type="radio" name="fromFilter" value="all" id="fromFilterAll" checked>
                    <label for="fromFilterAll">All</label>
                    <input type="radio" name="fromFilter" value="ancient" id="fromFilterAncient">
                    <label for="fromFilterAncient">Ancient</label>
                    <input type="radio" name="fromFilter" value="modern" id="fromFilterModern">
                    <label for="fromFilterModern">Modern</label>
                    <input type="radio" name="fromFilter" value="custom" id="fromFilterCustom">
                    <label for="fromFilterCustom">Custom</label>
                </div>
                <select id="fromUnit"></select>
            </div>
            
            <div class="form-group">
                <label for="toUnit">To:</label>
                <div class="filter-radios" id="toFilter">
                    <input type="radio" name="toFilter" value="all" id="toFilterAll" checked>
                    <label for="toFilterAll">All</label>
                    <input type="radio" name="toFilter" value="ancient" id="toFilterAncient">
                    <label for="toFilterAncient">Ancient</label>
                    <input type="radio" name="toFilter" value="modern" 
                    id="toFilterModern">
                    <label for="toFilterModern">Modern</label>
                    <input type="radio" name="toFilter" value="custom" id="toFilterCustom">
                    <label for="toFilterCustom">Custom</label>
                </div>
                <select id="toUnit"></select>
            </div>
            
            <button onclick="convertUnits()">Convert</button>
            
            <div id="result-area"></div>
        </div>

        <!-- Add Unit Section -->
        <button class="collapsible">Add a New Unit</button>
        <div class="collapsible-content">
            <div class="add-unit-form">
                <div class="form-group">
                    <label for="unitType">Type of Unit:</label>
                    <select id="unitType">
                        <option value="length">Length</option>
                        <option value="area">Area</option>
                        <option value="weight">Weight</option>
                        <option value="time">Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unitName">New Unit Name:</label>
                    <input type="text" id="unitName" placeholder="e.g., MyUnit">
                </div>
                <div class="form-group">
                    <label for="unitValue">Is equal to:</label>
                    <input type="number" id="unitValue" placeholder="e.g., 10">
                </div>
                <div class="form-group">
                    <label for="baseUnit">Of this existing unit (base units):</label>
                    <select id="baseUnit"></select>
                </div>
                
                <button onclick="saveUnit()">Save New Unit</button>
            </div>
        </div>
        
        <!-- Data Management Section -->
        <button class="collapsible">Data Management (Import/Export)</button>
        <div class="collapsible-content" style="gap: 10px;">
            <button onclick="importUnits()" class="secondary">Import Custom Units (.json)</button>
            <button onclick="exportUnits()" class="secondary">Export Custom Units (.json)</button>
            <button onclick="clearCustomUnits()" class="danger">Reset All Custom Units</button>
        </div>

    </div>

    <script>
        // --- BASE UNITS ---
        // Length: meter (m)
        // Area: square meter (m2)
        // Weight: gram (g)
        // Time: second (s)

        // Load the "database" from the JSON block in the HTML
        let unitData = JSON.parse(document.getElementById('unitDatabase').textContent);

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // A simple cache-first service worker
                const swCode = `
                    const CACHE_NAME = 'ancient-converter-cache-v3'; // Incremented cache version
                    const urlsToCache = ['.']; // Cache the start URL
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => {
                                return cache.addAll(urlsToCache);
                            })
                        );
                    });

                    // Clean up old caches
                    self.addEventListener('activate', event => {
                      event.waitUntil(
                        caches.keys().then(cacheNames => {
                          return Promise.all(
                            cacheNames.filter(cacheName => {
                              return cacheName !== CACHE_NAME;
                            }).map(cacheName => {
                              return caches.delete(cacheName);
                            })
                          );
                        })
                      );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                // Cache hit - return response
                                if (response) {
                                    return response;
                                }
                                // Not in cache - fetch, cache, and return
                                return fetch(event.request).then(networkResponse => {
                                    if(networkResponse && networkResponse.status === 200 && event.request.method === 'GET') {
                                        caches.open(CACHE_NAME).then(cache => {
                                            cache.put(event.request, networkResponse.clone());
                                        });
                                    }
                                    return networkResponse;
                                });
                            })
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob))
                    .then(reg => console.log('Service Worker registered.'))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        // --- PWA Install Prompt ---
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
            installButton.addEventListener('click', () => {
                installButton.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });

        /**
         * Loads custom units from localStorage and merges with default unitData.
         */
        function loadCustomUnits() {
            const customUnits = JSON.parse(localStorage.getItem('customUnits'));
            if (customUnits) {
                for (const type in customUnits) {
                    if (!unitData[type]) unitData[type] = {};
                    for (const unitName in customUnits[type]) {
                        unitData[type][unitName] = { 
                            factor: customUnits[type][unitName].factor, 
                            tag: 'custom' 
                        };
                    }
                }
            }
        }

        /**
         * Populates a single unit dropdown based on a filter.
         * @param {string} selectId - The ID of the <select> element (e.g., 'fromUnit')
         * @param {string} filter - The tag to filter by ('all', 'ancient', 'modern', 'custom')
         */
        function updateUnitList(selectId, filter) {
            const select = document.getElementById(selectId);
            const currentVal = select.value; // Preserve current selection
            select.innerHTML = '';

            for (const type in unitData) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = type.charAt(0).toUpperCase() + type.slice(1);
                
                let addedToGroup = false;
                const unitKeys = Object.keys(unitData[type]).sort();

                for (const unit of unitKeys) {
                    const unitInfo = unitData[type][unit];
                    
                    if (filter === 'all' || unitInfo.tag === filter) {
                        const option = document.createElement('option');
                        option.value = `${type}:${unit}`;
                        option.textContent = unit;
                        optGroup.appendChild(option);
                        addedToGroup = true;
                    }
                }

                if (addedToGroup) {
                    select.appendChild(optGroup);
                }
            }
            
            // Try to restore previous selection
            if (Array.from(select.options).some(opt => opt.value === currentVal)) {
                select.value = currentVal;
            }
        }
        
        /**
         * Populates the 'baseUnit' dropdown (always shows all units).
         */
        function populateBaseUnitList() {
            const select = document.getElementById('baseUnit');
            select.innerHTML = ''; // Clear existing
            
            for (const type in unitData) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = type.charAt(0).toUpperCase() + type.slice(1);
                
                const unitKeys = Object.keys(unitData[type]).sort();
                for (const unit of unitKeys) {
                    const option = document.createElement('option');
                    option.value = `${type}:${unit}`;
                    option.textContent = unit;
                    optGroup.appendChild(option);
                }
                select.appendChild(optGroup);
            }
        }

        /**
         * Ensures the 'To' dropdown only shows units of the same TYPE as the 'From' dropdown.
         */
        function syncToDropdownType() {
            const fromSelect = document.getElementById('fromUnit');
            const toSelect = document.getElementById('toUnit');
            const resultArea = document.getElementById('result-area');

            const selectedFrom = fromSelect.value;
            
            if (!selectedFrom) {
                resultArea.textContent = '';
                // Show all optgroups if nothing is selected
                Array.from(toSelect.children).forEach(optGroup => optGroup.style.display = '');
                return;
            }

            const [fromType, fromUnitName] = selectedFrom.split(':');
            
            // Hide/show optgroups in 'to' dropdown
            Array.from(toSelect.children).forEach(optGroup => {
                const groupType = optGroup.label.toLowerCase();
                optGroup.style.display = (groupType === fromType) ? '' : 'none';
            });
            
            // If current 'to' selection is not valid, reset it
            const currentTo = toSelect.value;
            if (currentTo) {
                const [toType, toUnitName] = currentTo.split(':');
                if (toType !== fromType) {
                    toSelect.value = ''; // Reset selection
                }
            }

            resultArea.textContent = ''; // Clear result on change
        }

        /**
         * Performs the unit conversion and displays the result.
         */
        function convertUnits() {
            const value = parseFloat(document.getElementById('inputValue').value);
            const fromSelect = document.getElementById('fromUnit');
            const toSelect = document.getElementById('toUnit');
            const resultArea = document.getElementById('result-area');
            
            resultArea.style.display = 'block'; // Ensure result area is visible
            if (isNaN(value)) {
                resultArea.textContent = 'Please enter a valid number.';
                return;
            }

            const fromVal = fromSelect.value;
            const toVal = toSelect.value;

            if (!fromVal || !toVal) {
                resultArea.textContent = 'Please select both units.';
                return;
            }

            const [fromType, fromUnitName] = fromVal.split(':');
            const [toType, toUnitName] = toVal.split(':');

            if (fromType !== toType) {
                resultArea.textContent = 'Error: Cannot convert between different unit types.';
                return;
            }

            const fromFactor = unitData[fromType][fromUnitName].factor;
            const toFactor = unitData[toType][toUnitName].factor;

            const result = (value * fromFactor) / toFactor;
            
            resultArea.textContent = `${value} ${fromUnitName} = ${result.toPrecision(8)} ${toUnitName}`;
        }

        /**
         * Saves a new custom unit to localStorage.
         */
        function saveUnit() {
            const type = document.getElementById('unitType').value;
            const name = document.getElementById('unitName').value.trim();
            const value = parseFloat(document.getElementById('unitValue').value);
            const baseUnitSelection = document.getElementById('baseUnit').value;

            if (!name || isNaN(value) || !baseUnitSelection) {
                alert('Please fill in all fields for the new unit.');
                return;
            }
            
            if (unitData[type] && unitData[type][name]) {
                if (!confirm(`A unit named "${name}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }

            const [baseType, baseUnitName] = baseUnitSelection.split(':');

            if (type !== baseType) {
                alert('The new unit must be the same type as its base unit.');
                return;
            }

            const baseFactor = unitData[baseType][baseUnitName].factor;
            const newUnitFactor = value * baseFactor;

            let customUnits = JSON.parse(localStorage.getItem('customUnits')) || {};
            if (!customUnits[type]) customUnits[type] = {};
            customUnits[type][name] = { factor: newUnitFactor, tag: 'custom' };
            localStorage.setItem('customUnits', JSON.stringify(customUnits));

            // Reload all units and repopulate dropdowns
            loadCustomUnits();
            const fromFilter = document.querySelector('input[name="fromFilter"]:checked').value;
            const toFilter = document.querySelector('input[name="toFilter"]:checked').value;
            updateUnitList('fromUnit', fromFilter);
            updateUnitList('toUnit', toFilter);
            populateBaseUnitList();

            alert(`Unit "${name}" saved!`);
            document.getElementById('unitName').value = '';
            document.getElementById('unitValue').value = '';
        }

        /**
         * Clears all custom units from localStorage.
         */
        function clearCustomUnits() {
            if (confirm('Are you sure you want to delete all custom units? This cannot be undone.')) {
                localStorage.removeItem('customUnits');
                location.reload(); 
            }
        }
        
        /**
         * Exports custom units to a JSON file.
         */
        function exportUnits() {
            const customUnits = localStorage.getItem('customUnits');
            if (!customUnits) {
                alert('No custom units to export.');
                return;
            }
            const blob = new Blob([customUnits], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ancient_converter_units.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * Imports custom units from a JSON file.
         */
        function importUnits() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (typeof importedData !== 'object' || Array.isArray(importedData)) {
                            throw new Error('Invalid file format. Expected a JSON object.');
                        }
                        
                        let customUnits = JSON.parse(localStorage.getItem('customUnits')) || {};
                        for (const type in importedData) {
                            if (!customUnits[type]) customUnits[type] = {};
                            Object.assign(customUnits[type], importedData[type]);
                        }
                        
                        localStorage.setItem('customUnits', JSON.stringify(customUnits));
                        alert('Units imported successfully! Reloading...');
                        location.reload();
                    } catch (err) {
                        alert(`Error importing file: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        /**
         * Sets up collapsible sections.
         */
        function setupCollapsibles() {
            const colls = document.getElementsByClassName("collapsible");
            for (let i = 0; i < colls.length; i++) {
                colls[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        content.classList.remove('open');
                    } else {
                        content.style.maxHeight = content.scrollHeight + 40 + "px"; // 40 for padding
                        content.classList.add('open');
                    }
                });
            }
        }

        // --- Initial Setup ---
        
        // Add event listeners
        document.getElementById('fromUnit').addEventListener('change', syncToDropdownType);
        
        document.getElementById('fromFilter').addEventListener('change', (e) => {
            updateUnitList('fromUnit', e.target.value);
            syncToDropdownType(); // Re-sync type display
        });
        
        document.getElementById('toFilter').addEventListener('change', (e) => {
            updateUnitList('toUnit', e.target.value);
            syncToDropdownType(); // Re-sync type display
        });


        // Load custom units and populate dropdowns on page load
        loadCustomUnits();
        updateUnitList('fromUnit', 'all');
        updateUnitList('toUnit', 'all');
        populateBaseUnitList();
        setupCollapsibles();
        
        // Manually filter 'to' dropdown to match initial 'from' selection (if any)
        syncToDropdownType();

    </script>
</body>
</html>